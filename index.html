<!DOCTYPE html>
<html>
<head>
    <title>Task Admin UI</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }
        .user-details {
            display: flex;
            flex-direction: column;
        }
        .user-name {
            font-weight: 600;
            color: #333;
        }
        .user-roles {
            font-size: 12px;
            color: #666;
        }
        .user-roles .role-badge {
            display: inline-block;
            background: #e0e0e0;
            color: #333;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin: 0 2px;
        }
        .logout-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: background 0.3s;
        }
        .logout-btn:hover {
            background: #d32f2f;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 0;
        }
        .tab-button {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            margin-bottom: -2px;
        }
        .tab-button:hover {
            color: #007acc;
            background: #f5f5f5;
        }
        .tab-button.active {
            color: #007acc;
            border-bottom-color: #007acc;
            background: none;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .command-form {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        label {
            font-weight: 600;
            color: #555;
        }
        select, input, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #007acc;
        }
        .args-input {
            font-family: 'Courier New', monospace;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background: #005a9e;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .output-section {
            margin-top: 20px;
        }
        .output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            min-height: 200px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .output.error {
            border-left: 4px solid #f44336;
        }
        .output.success {
            border-left: 4px solid #4caf50;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007acc;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: none;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .history {
            margin-top: 30px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        .history-item {
            background: #f9f9f9;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        .history-item:hover {
            background: #f0f0f0;
        }
        .history-item .username {
            color: #666;
            font-size: 12px;
            margin-left: 10px;
            font-style: italic;
        }
        .timestamp {
            color: #666;
            font-size: 12px;
        }
        .permission-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 5px;
        }
        .permission-badge.read {
            background: #2196f3;
        }
        .permission-badge.write {
            background: #ff9800;
        }
        
        /* Console Control Styles */
        .console-form {
            display: grid;
            gap: 20px;
            margin-bottom: 20px;
        }
        .file-upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: #fafafa;
        }
        .file-upload-area:hover {
            border-color: #007acc;
            background: #f0f8ff;
        }
        .file-upload-area.dragover {
            border-color: #007acc;
            background: #e3f2fd;
            transform: scale(1.02);
        }
        .upload-prompt {
            color: #666;
        }
        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        .file-icon {
            font-size: 32px;
        }
        .file-details {
            flex: 1;
            text-align: left;
        }
        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        .file-size {
            font-size: 13px;
            color: #666;
        }
        .file-remove {
            background: #f44336;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        .file-remove:hover {
            background: #d32f2f;
        }
        .console-execute-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-size: 16px;
            padding: 14px 24px;
        }
        .console-execute-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
    <style>
    /* Corporate Actions Styles */
    .ca-filters {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .filter-row {
        display: flex;
        gap: 20px;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-group label {
        font-size: 13px;
        font-weight: 600;
        color: #555;
    }

    .ca-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }

    .summary-number {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 5px;
    }

    .summary-label {
        font-size: 13px;
        opacity: 0.9;
    }

    .ca-table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
    }

    .ca-table-wrapper {
        overflow-x: auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .ca-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .ca-table thead {
        background: #f5f5f5;
    }

    .ca-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #e0e0e0;
        font-size: 13px;
        white-space: nowrap;
    }

    .ca-table td {
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 13px;
    }

    .ca-table tbody tr:hover {
        background: #f9f9f9;
    }

    .ca-type-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        background: #e0e0e0;
        color: #333;
    }

    .ca-type-badge.dividend {
        background: #4caf50;
        color: white;
    }

    .ca-type-badge.split {
        background: #2196f3;
        color: white;
    }

    .ca-type-badge.merger {
        background: #ff9800;
        color: white;
    }

    .ca-type-badge.rights {
        background: #9c27b0;
        color: white;
    }

    .days-badge {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
    }

    .days-badge.urgent {
        background: #ffebee;
        color: #c62828;
    }

    .days-badge.soon {
        background: #fff3e0;
        color: #e65100;
    }

    .days-badge.upcoming {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .booking-instruments-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        max-height: 300px;
        overflow-y: auto;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 8px;
    }

    .booking-instrument-card {
        background: white;
        padding: 12px;
        border-radius: 6px;
        border-left: 3px solid #007acc;
        font-size: 13px;
    }

    .booking-instrument-card .symbol {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }

    .booking-instrument-card .details {
        color: #666;
        font-size: 12px;
    }

    .ca-loading {
        text-align: center;
        padding: 40px;
    }

    .view-details-btn {
        background: #007acc;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .view-details-btn:hover {
        background: #005a9e;
    }

    /* Modal Dialog Styles */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        animation: fadeIn 0.2s;
    }

    .modal-overlay.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-dialog {
        background: white;
        border-radius: 8px;
        max-width: 900px;
        width: 90%;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s;
    }

    @keyframes slideUp {
        from {
            transform: translateY(30px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        padding: 20px 25px;
        border-bottom: 2px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        margin: 0;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        color: #666;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .modal-close:hover {
        background: #f5f5f5;
        color: #333;
    }

    .modal-body {
        padding: 25px;
        overflow-y: auto;
        flex: 1;
    }

    .modal-footer {
        padding: 15px 25px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .detail-item {
        background: #f9f9f9;
        padding: 12px;
        border-radius: 6px;
        border-left: 3px solid #007acc;
    }

    .detail-label {
        font-size: 11px;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
        margin-bottom: 5px;
        letter-spacing: 0.5px;
    }

    .detail-value {
        font-size: 14px;
        color: #333;
        word-break: break-word;
    }

    .detail-value.empty {
        color: #999;
        font-style: italic;
    }

    .varfields-section {
        margin-top: 25px;
        padding-top: 20px;
        border-top: 2px solid #e0e0e0;
    }

    .varfields-section h3 {
        font-size: 16px;
        color: #333;
        margin-bottom: 15px;
    }

    .varfields-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
    }

    .varfields-table th {
        background: #f5f5f5;
        padding: 10px;
        text-align: left;
        font-size: 12px;
        font-weight: 600;
        color: #555;
        border-bottom: 2px solid #e0e0e0;
    }

    .varfields-table td {
        padding: 10px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 13px;
    }

    .varfields-table tr:last-child td {
        border-bottom: none;
    }

    .varfields-table tr:hover {
        background: #f9f9f9;
    }

    .modal-loading {
        text-align: center;
        padding: 60px 20px;
    }

    .modal-loading .spinner {
        width: 40px;
        height: 40px;
        border-width: 4px;
    }

    .copy-json-btn {
        background: #4caf50;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 13px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .copy-json-btn:hover {
        background: #388e3c;
    }

    .no-varfields {
        text-align: center;
        padding: 30px;
        color: #666;
        font-style: italic;
    }
    </style>
</head>
<body>
    <div class="header">
        <div class="user-info">
            <div class="user-avatar">
                {{ user.full_name[0]|upper if user.full_name else user.username[0]|upper }}
            </div>
            <div class="user-details">
                <div class="user-name">
                    {{ user.full_name or user.username }}
                    {% if user.permissions.can_read %}
                        <span class="permission-badge read">READ</span>
                    {% endif %}
                    {% if user.permissions.can_write %}
                        <span class="permission-badge write">WRITE</span>
                    {% endif %}
                </div>
                <div class="user-roles">
                    {{ user.email or user.username }} â€¢ 
                    {% if user.relevant_roles %}
                        Active roles: 
                        {% for role in user.relevant_roles %}
                            <span class="role-badge">{{ role }}</span>
                        {% endfor %}
                    {% else %}
                        No active roles
                    {% endif %}
                </div>
            </div>
        </div>
        <a href="{{ base_path }}/logout" class="logout-btn">Logout</a>
    </div>

    <div class="container">
        <h1>Task Admin Control Panel</h1>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('task-admin')">
                ðŸ”§ Task Admin
            </button>
            {% if 'console_control' in commands %}
            <button class="tab-button" onclick="switchTab('console-control')">
                ðŸ“Š Console Control
            </button>
            {% endif %}
            <button class="tab-button" onclick="switchTab('corporate-actions')">
                ðŸ“ˆ Corporate Actions
            </button>
        </div>
        
        <!-- Task Admin Tab -->
        <div id="task-admin-tab" class="tab-content active">
            <div class="command-form">
                <div>
                    <label for="command">Command:</label>
                    <select id="command">
                        <option value="">-- Select Command --</option>
                        {% for cmd in commands %}
                        {% if cmd != 'console_control' %}
                        <option value="{{ cmd }}">{{ cmd }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="args">Arguments (space-separated or one per line):</label>
                    <textarea id="args" rows="3" class="args-input" 
                        placeholder="arg1 arg2 arg3&#10;or&#10;arg1&#10;arg2&#10;arg3"></textarea>
                </div>
                
                <div>
                    <button id="executeBtn" onclick="executeCommand()">
                        Execute Command
                    </button>
                    <button id="clearBtn" onclick="clearOutput()" style="background: #666; margin-left: 10px;">
                        Clear Output
                    </button>
                </div>
            </div>
            
            <div class="status" id="status"></div>
            
            <div class="output-section">
                <label>Output:</label>
                <div id="output" class="output">Ready to execute commands...</div>
            </div>
            
            <div class="history" id="history">
                <h3>
                    Command History - Task Admin
                    <span id="lastRefresh" style="font-size: 12px; color: #999; font-weight: normal; margin-left: 10px;"></span>
                    <button onclick="loadHistoryFromServer()" style="float: right; padding: 5px 15px; font-size: 13px; background: #007acc; margin-top: -5px;">
                        ðŸ”„ Refresh
                    </button>
                </h3>
                <div id="historyList"></div>
            </div>
        </div>
        <!-- End Task Admin Tab -->
        
        {% if 'console_control' in commands %}
        <!-- Console Control Tab -->
        <div id="console-control-tab" class="tab-content">
            <h2 style="margin-top: 0;">ðŸ“Š Console Control - Booking Load & Book</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                Upload a CSV file to execute the booking workflow through the console control interface.<br>
                <strong>Process:</strong> 1) booking_load (CSV file) â†’ 2) booking_book all
            </p>
            
            <div class="console-form">
                <div class="file-upload-area" id="fileUploadArea">
                    <input 
                        type="file" 
                        id="csvFile" 
                        accept=".csv,.txt"
                        style="display: none;"
                        onchange="handleFileSelect(event)"
                    >
                    <div class="upload-prompt" onclick="document.getElementById('csvFile').click()">
                        <div style="font-size: 48px; margin-bottom: 10px;">ðŸ“</div>
                        <div style="font-weight: 600; margin-bottom: 5px;">Click to select CSV file</div>
                        <div style="font-size: 13px; color: #666;">or drag and drop here</div>
                        <div style="font-size: 12px; color: #999; margin-top: 10px;">Max file size: 16MB</div>
                    </div>
                    <div class="file-info" id="fileInfo" style="display: none;">
                        <div class="file-icon">ðŸ“„</div>
                        <div class="file-details">
                            <div class="file-name" id="fileName"></div>
                            <div class="file-size" id="fileSize"></div>
                        </div>
                        <button class="file-remove" onclick="removeFile()">âœ•</button>
                    </div>
                </div>
                
                <button 
                    id="consoleExecuteBtn" 
                    onclick="executeConsoleCommand()"
                    disabled
                    class="console-execute-btn"
                >
                    ðŸš€ Execute Booking Workflow
                </button>
            </div>
            
            <div class="status" id="console-status"></div>
            
            <div class="output-section">
                <label>Output:</label>
                <div id="console-output" class="output">Ready to execute console commands...</div>
            </div>
            
            <div class="history" id="console-history">
                <h3>
                    Command History - Console Control
                    <span id="consoleLastRefresh" style="font-size: 12px; color: #999; font-weight: normal; margin-left: 10px;"></span>
                    <button onclick="loadConsoleHistoryFromServer()" style="float: right; padding: 5px 15px; font-size: 13px; background: #007acc; margin-top: -5px;">
                        ðŸ”„ Refresh
                    </button>
                </h3>
                <div id="consoleHistoryList"></div>
            </div>
        </div>
        <!-- End Console Control Tab -->
        {% endif %}
        
        <!-- Corporate Actions Tab -->
        <div id="corporate-actions-tab" class="tab-content">
            <h2 style="margin-top: 0;">ðŸ“Š Bloomberg Corporate Actions</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                View upcoming corporate actions for the next 7 days. Filter by instruments in current bookings.
            </p>
            
            <!-- Filters -->
            <div class="ca-filters">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="daysAhead">ðŸ“… Days Ahead:</label>
                        <select id="daysAhead" onchange="loadCorporateActions()">
                            <option value="1">1 day</option>
                            <option value="3">3 days</option>
                            <option value="7" selected>7 days</option>
                            <option value="14">14 days</option>
                            <option value="30">30 days</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="caSearch">ðŸ” Search:</label>
                        <input 
                            type="text" 
                            id="caSearch" 
                            placeholder="Search ticker or company..."
                            style="min-width: 250px;"
                        >
                    </div>
                    
                    <div class="filter-group">
                        <label>
                            <input 
                                type="checkbox" 
                                id="bookingOnlyFilter" 
                                onchange="loadCorporateActions()"
                                style="width: auto; margin-right: 5px;"
                            >
                            ðŸ“š Booking Instruments Only
                        </label>
                    </div>
                    
                    <button 
                        onclick="loadCorporateActions()" 
                        style="background: #007acc; padding: 10px 20px; margin-left: auto;"
                    >
                        ðŸ”„ Refresh
                    </button>
                </div>
            </div>
            
            <!-- Summary Cards -->
            <div id="caSummary" class="ca-summary" style="display: none;">
                <div class="summary-card">
                    <div class="summary-number" id="totalCAs">0</div>
                    <div class="summary-label">Total Actions</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="totalInstruments">0</div>
                    <div class="summary-label">Affected Instruments</div>
                </div>
                <div class="summary-card" id="caTypesSummary">
                    <div class="summary-label">CA Types</div>
                    <div id="caTypesContent" style="font-size: 12px; margin-top: 5px;"></div>
                </div>
            </div>
            
            <!-- Loading / Status -->
            <div id="caStatus" class="status" style="display: none;"></div>
            <div id="caLoading" class="ca-loading" style="display: none;">
                <div class="spinner" style="margin: 20px auto;"></div>
                <p style="text-align: center; color: #666;">Loading corporate actions...</p>
            </div>
            
            <!-- Results Table -->
            <div id="caResultsContainer" style="display: none;">
                <div class="ca-table-header">
                    <h3 style="margin: 0;">Corporate Actions Results</h3>
                    <button onclick="exportToCSV()" style="background: #4caf50; padding: 8px 16px; font-size: 13px;">
                        ðŸ“¥ Export CSV
                    </button>
                </div>
                
                <div class="ca-table-wrapper">
                    <table class="ca-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Days</th>
                                <th>Ticker</th>
                                <th>Company</th>
                                <th>CA Type</th>
                                <th>Currency</th>
                                <th>Sector</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="caTableBody">
                            <!-- Results populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- No Results Message -->
            <div id="caNoResults" style="display: none; text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 15px;">ðŸ“Š</div>
                <h3>No Corporate Actions Found</h3>
                <p>Try adjusting your filters or search criteria</p>
            </div>
            
            <!-- Booking Instruments Panel (shown when filter is active) -->
            <div id="bookingInstrumentsPanel" style="display: none; margin-top: 30px;">
                <h3>ðŸ“š Instruments in Current Bookings (<span id="bookingInstrCount">0</span>)</h3>
                <div class="booking-instruments-grid" id="bookingInstrumentsGrid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let executing = false;
        let commandHistory = [];
        let consoleCommandHistory = [];
        let autoRefreshInterval;
        // ============================================
        // ANSI Escape Code Stripping
        // ============================================
        
        function stripAnsiCodes(text) {
            // Remove ANSI escape sequences
            // This handles cases where ESC might be represented differently or partially stripped
            return text
                // Remove complete ANSI CSI sequences with ESC character
                .replace(/\x1B\[[0-9;?]*[A-Za-z]/g, '')
                // Remove CSI sequences without ESC (in case ESC was already removed elsewhere)
                .replace(/\[[\?0-9;]*[hlHJKmsu]/g, '')
                // Remove OSC sequences
                .replace(/\x1B\][^\x07]*\x07/g, '')
                // Remove other escape sequences with ESC
                .replace(/\x1B[=>()]/g, '')
                // Remove bracketed paste mode with ESC
                .replace(/\x1B\[\?[0-9]+[hl]/g, '')
                // Remove standalone control sequences that lost their ESC
                .replace(/\?[0-9]+[hl]>/g, '')
                .replace(/\[[0-9;]+m/g, '')
                // Clean up any remaining malformed sequences at line starts
                .replace(/^\?[0-9]+[hl]/gm, '')
                // Remove ESC followed by any character
                .replace(/\x1B./g, '');
        }
        
        // ============================================
        // Console Control Functions
        // ============================================
        
        let uploadedFile = null;
        let currentTab = 'task-admin';

        // Load history on page load
        window.onload = function() {
            loadHistoryFromServer();
            
            // Auto-refresh history every 30 seconds
            autoRefreshInterval = setInterval(() => {
                if (currentTab === 'task-admin') {
                    loadHistoryFromServer();
                } else if (currentTab === 'console-control') {
                    loadConsoleHistoryFromServer();
                }
            }, 30000);
            
            // Setup drag and drop for file upload
            setupDragAndDrop();
        };
        
        // Clean up interval on page unload
        window.onbeforeunload = function() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        };
        
        // Tab switching function
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Activate selected button
            event.target.classList.add('active');
            
            // Load appropriate history
            if (tabName === 'console-control') {
                loadConsoleHistoryFromServer();
            } else {
                loadHistoryFromServer();
            }
        }
        
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('fileUploadArea');
            if (!uploadArea) return;
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.add('dragover');
                }, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => {
                    uploadArea.classList.remove('dragover');
                }, false);
            });
            
            uploadArea.addEventListener('drop', handleDrop, false);
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                const file = files[0];
                handleFile(file);
            }
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }
        
        function handleFile(file) {
            const allowedTypes = ['text/csv', 'text/plain', 'application/vnd.ms-excel'];
            const fileName = file.name.toLowerCase();
            
            if (!fileName.endsWith('.csv') && !fileName.endsWith('.txt') && !allowedTypes.includes(file.type)) {
                showConsoleStatus('Only CSV and TXT files are allowed', 'error');
                return;
            }
            
            if (file.size > 16 * 1024 * 1024) {
                showConsoleStatus('File size must be less than 16MB', 'error');
                return;
            }
            
            uploadFile(file);
        }
        
        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            const uploadArea = document.getElementById('fileUploadArea');
            const uploadPrompt = uploadArea.querySelector('.upload-prompt');
            
            uploadPrompt.innerHTML = '<div class="spinner"></div> Uploading...';
            
            try {
                const response = await fetch('{{ base_path }}/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.status === 401) {
                    window.location.href = '{{ base_path }}/login?next=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                const data = await response.json();
                
                if (response.ok) {
                    uploadedFile = {
                        filename: data.filename,
                        originalName: data.original_filename,
                        size: data.size
                    };
                    
                    displayFileInfo();
                    showConsoleStatus('File uploaded successfully', 'success');
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                showConsoleStatus('Upload failed: ' + error.message, 'error');
                uploadPrompt.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 10px;">ðŸ“</div>
                    <div style="font-weight: 600; margin-bottom: 5px;">Click to select CSV file</div>
                    <div style="font-size: 13px; color: #666;">or drag and drop here</div>
                    <div style="font-size: 12px; color: #999; margin-top: 10px;">Max file size: 16MB</div>
                `;
            }
        }
        
        function displayFileInfo() {
            const uploadArea = document.getElementById('fileUploadArea');
            const uploadPrompt = uploadArea.querySelector('.upload-prompt');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const executeBtn = document.getElementById('consoleExecuteBtn');
            
            uploadPrompt.style.display = 'none';
            fileInfo.style.display = 'flex';
            
            fileName.textContent = uploadedFile.originalName;
            fileSize.textContent = formatFileSize(uploadedFile.size);
            
            executeBtn.disabled = false;
            uploadArea.style.cursor = 'default';
        }
        
        function removeFile() {
            uploadedFile = null;
            
            const uploadArea = document.getElementById('fileUploadArea');
            const uploadPrompt = uploadArea.querySelector('.upload-prompt');
            const fileInfo = document.getElementById('fileInfo');
            const executeBtn = document.getElementById('consoleExecuteBtn');
            const fileInput = document.getElementById('csvFile');
            
            // Restore the original upload prompt HTML
            uploadPrompt.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 10px;">ðŸ“</div>
                <div style="font-weight: 600; margin-bottom: 5px;">Click to select CSV file</div>
                <div style="font-size: 13px; color: #666;">or drag and drop here</div>
                <div style="font-size: 12px; color: #999; margin-top: 10px;">Max file size: 16MB</div>
            `;
            
            uploadPrompt.style.display = 'block';
            fileInfo.style.display = 'none';
            executeBtn.disabled = true;
            fileInput.value = '';
            
            uploadArea.style.cursor = 'pointer';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        async function executeConsoleCommand() {
            if (executing || !uploadedFile) return;
            
            executing = true;
            const btn = document.getElementById('consoleExecuteBtn');
            const output = document.getElementById('console-output');
            
            btn.innerHTML = 'â³ Executing... <div class="spinner"></div>';
            btn.disabled = true;
            
            output.textContent = `Executing booking workflow: ${uploadedFile.originalName}\n\n1. booking_load ${uploadedFile.originalName}\n2. booking_book all\n\nPlease wait, this may take several minutes for large files...\n\n`;
            output.className = 'output';
            
            try {
                const response = await fetch('{{ base_path }}/console-execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        csv_filename: uploadedFile.filename
                    })
                });
                
                if (response.status === 401) {
                    window.location.href = '{{ base_path }}/login?next=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                const data = await response.json();
                
                if (response.ok) {
                    let outputText = `Booking Workflow Execution:\n`;
                    outputText += `1. booking_load ${uploadedFile.originalName}\n`;
                    outputText += `2. booking_book all\n`;
                    outputText += `Return Code: ${data.returncode}\n`;
                    outputText += 'â”€'.repeat(60) + '\n\n';
                    
                    if (data.stdout) {
                        // Strip ANSI codes from stdout
                        const cleanStdout = stripAnsiCodes(data.stdout);
                        outputText += 'STDOUT:\n' + cleanStdout + '\n';
                    }
                    
                    if (data.stderr) {
                        // Strip ANSI codes from stderr
                        const cleanStderr = stripAnsiCodes(data.stderr);
                        outputText += '\nSTDERR:\n' + cleanStderr;
                    }
                    
                    output.textContent = outputText;
                    output.className = data.success ? 'output success' : 'output error';
                    
                    await loadConsoleHistoryFromServer();
                    
                    showConsoleStatus(
                        data.success ? 'Console command executed successfully' : 'Console command failed', 
                        data.success ? 'success' : 'error'
                    );
                    
                    if (data.success) {
                        removeFile();
                    }
                } else {
                    output.textContent = `Error: ${data.error}`;
                    output.className = 'output error';
                    showConsoleStatus(data.error, 'error');
                }
            } catch (error) {
                output.textContent = `Network Error: ${error.message}`;
                output.className = 'output error';
                showConsoleStatus('Failed to execute console command', 'error');
            } finally {
                btn.innerHTML = 'ðŸš€ Execute Booking Workflow';
                btn.disabled = false;
                executing = false;
            }
        }

        async function loadHistoryFromServer() {
            const refreshBtn = document.querySelector('#history button[onclick="loadHistoryFromServer()"]');
            const originalText = refreshBtn ? refreshBtn.innerHTML : '';
            
            if (refreshBtn) {
                refreshBtn.innerHTML = 'â³ Loading...';
                refreshBtn.disabled = true;
            }
            
            try {
                const response = await fetch('{{ base_path }}/history');
                if (response.ok) {
                    const data = await response.json();
                    // Filter out console_control commands
                    commandHistory = data.history.filter(item => item.command !== 'console_control');
                    renderHistory();
                    
                    const lastRefreshEl = document.getElementById('lastRefresh');
                    if (lastRefreshEl) {
                        lastRefreshEl.textContent = `(Last updated: ${new Date().toLocaleTimeString()})`;
                    }
                } else {
                    commandHistory = {{ initial_history | tojson | safe }}.filter(item => item.command !== 'console_control');
                    renderHistory();
                }
            } catch (error) {
                console.error('Failed to load history:', error);
                commandHistory = {{ initial_history | tojson | safe }}.filter(item => item.command !== 'console_control');
                renderHistory();
            } finally {
                if (refreshBtn) {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                }
            }
        }
        
        async function loadConsoleHistoryFromServer() {
            const refreshBtn = document.querySelector('#console-history button[onclick="loadConsoleHistoryFromServer()"]');
            const originalText = refreshBtn ? refreshBtn.innerHTML : '';
            
            if (refreshBtn) {
                refreshBtn.innerHTML = 'â³ Loading...';
                refreshBtn.disabled = true;
            }
            
            try {
                const response = await fetch('{{ base_path }}/history');
                if (response.ok) {
                    const data = await response.json();
                    // Filter only console_control commands
                    consoleCommandHistory = data.history.filter(item => item.command === 'console_control');
                    renderConsoleHistory();
                    
                    const lastRefreshEl = document.getElementById('consoleLastRefresh');
                    if (lastRefreshEl) {
                        lastRefreshEl.textContent = `(Last updated: ${new Date().toLocaleTimeString()})`;
                    }
                } else {
                    consoleCommandHistory = {{ initial_history | tojson | safe }}.filter(item => item.command === 'console_control');
                    renderConsoleHistory();
                }
            } catch (error) {
                console.error('Failed to load console history:', error);
                consoleCommandHistory = {{ initial_history | tojson | safe }}.filter(item => item.command === 'console_control');
                renderConsoleHistory();
            } finally {
                if (refreshBtn) {
                    refreshBtn.innerHTML = originalText;
                    refreshBtn.disabled = false;
                }
            }
        }

        async function executeCommand() {
            if (executing) return;
            
            const command = document.getElementById('command').value;
            const argsText = document.getElementById('args').value;
            
            if (!command) {
                showStatus('Please select a command', 'error');
                return;
            }
            
            const args = parseArguments(argsText);
            
            executing = true;
            const btn = document.getElementById('executeBtn');
            const output = document.getElementById('output');
            
            btn.innerHTML = 'Executing... <div class="spinner"></div>';
            btn.disabled = true;
            
            output.textContent = `Executing: task_admin -c config.xml ${command} ${args.join(' ')}\n\n`;
            output.className = 'output';
            
            try {
                const response = await fetch('{{ base_path }}/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ command, args })
                });
                
                if (response.status === 401) {
                    window.location.href = '{{ base_path }}/login?next=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                const data = await response.json();
                
                if (response.ok) {
                    let outputText = `Command: task_admin -c config.xml ${command} ${args.join(' ')}\n`;
                    outputText += `Return Code: ${data.returncode}\n`;
                    outputText += 'â”€'.repeat(60) + '\n\n';
                    
                    if (data.stdout) {
                        // Strip ANSI codes from stdout
                        const cleanStdout = stripAnsiCodes(data.stdout);
                        outputText += 'STDOUT:\n' + cleanStdout + '\n';
                    }
                    
                    if (data.stderr) {
                        // Strip ANSI codes from stderr
                        const cleanStderr = stripAnsiCodes(data.stderr);
                        outputText += '\nSTDERR:\n' + cleanStderr;
                    }
                    
                    output.textContent = outputText;
                    output.className = data.success ? 'output success' : 'output error';
                    
                    await loadHistoryFromServer();
                    
                    showStatus(
                        data.success ? 'Command executed successfully' : 'Command failed', 
                        data.success ? 'success' : 'error'
                    );
                } else {
                    output.textContent = `Error: ${data.error}`;
                    output.className = 'output error';
                    showStatus(data.error, 'error');
                }
            } catch (error) {
                output.textContent = `Network Error: ${error.message}`;
                output.className = 'output error';
                showStatus('Failed to execute command', 'error');
            } finally {
                btn.innerHTML = 'Execute Command';
                btn.disabled = false;
                executing = false;
            }
        }
        
        function clearOutput() {
            if (currentTab === 'task-admin') {
                document.getElementById('output').textContent = 'Ready to execute commands...';
                document.getElementById('output').className = 'output';
                document.getElementById('status').style.display = 'none';
            } else {
                document.getElementById('console-output').textContent = 'Ready to execute console commands...';
                document.getElementById('console-output').className = 'output';
                document.getElementById('console-status').style.display = 'none';
            }
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }
        
        function showConsoleStatus(message, type) {
            const status = document.getElementById('console-status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 5000);
        }
        
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            if (commandHistory.length === 0) {
                historyList.innerHTML = '<p style="color: #666;">No command history yet</p>';
                return;
            }
            
            historyList.innerHTML = commandHistory.map((item, index) => {
                const statusIcon = item.success ? 'âœ“' : 'âœ—';
                const borderColor = item.success ? '#4caf50' : '#f44336';
                return `
                    <div class="history-item" onclick="loadFromHistory(${index})" style="border-left-color: ${borderColor};">
                        <div>
                            ${statusIcon} 
                            <strong>${item.command}</strong> ${item.args.join(' ')}
                            ${item.username ? `<span class="username">by ${item.username}</span>` : ''}
                        </div>
                        <div class="timestamp">${new Date(item.timestamp).toLocaleString()}</div>
                    </div>
                `;
            }).join('');
        }
        
        function renderConsoleHistory() {
            const historyList = document.getElementById('consoleHistoryList');
            if (consoleCommandHistory.length === 0) {
                historyList.innerHTML = '<p style="color: #666;">No console command history yet</p>';
                return;
            }
            
            historyList.innerHTML = consoleCommandHistory.map((item, index) => {
                const statusIcon = item.success ? 'âœ“' : 'âœ—';
                const borderColor = item.success ? '#4caf50' : '#f44336';
                const fileName = item.args.length > 1 ? item.args[1] : 'unknown';
                return `
                    <div class="history-item" style="border-left-color: ${borderColor};">
                        <div>
                            ${statusIcon} 
                            <strong>${item.args[0] || 'booking_load'}</strong> - ${fileName}
                            ${item.username ? `<span class="username">by ${item.username}</span>` : ''}
                        </div>
                        <div class="timestamp">${new Date(item.timestamp).toLocaleString()}</div>
                    </div>
                `;
            }).join('');
        }
        
        function loadFromHistory(index) {
            const item = commandHistory[index];
            document.getElementById('command').value = item.command;
            document.getElementById('args').value = item.args.join(' ');
        }

        function parseArguments(argsText) {
            const args = [];
            let current = '';
            let inQuotes = false;
            let quoteChar = '';
            
            for (let i = 0; i < argsText.length; i++) {
                const char = argsText[i];
                
                if ((char === '"' || char === "'") && !inQuotes) {
                    inQuotes = true;
                    quoteChar = char;
                } else if (char === quoteChar && inQuotes) {
                    inQuotes = false;
                    quoteChar = '';
                    if (current.trim()) {
                        args.push(current.trim());
                        current = '';
                    }
                } else if ((char === ' ' || char === '\n') && !inQuotes) {
                    if (current.trim()) {
                        args.push(current.trim());
                        current = '';
                    }
                } else {
                    current += char;
                }
            }
            
            if (current.trim()) {
                args.push(current.trim());
            }
            
            return args;
        }
        
        document.getElementById('args').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                executeCommand();
            }
        });
    </script>

    <script>
    // Corporate Actions JavaScript
    let caData = [];
    let bookingInstruments = [];
    let searchTimeout = null;

    // Add debounced search
    document.getElementById('caSearch').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadCorporateActions();
        }, 500);
    });

    async function loadCorporateActions() {
        const daysAhead = document.getElementById('daysAhead').value;
        const bookingOnly = document.getElementById('bookingOnlyFilter').checked;
        const search = document.getElementById('caSearch').value.trim();
        
        // Show loading
        document.getElementById('caLoading').style.display = 'block';
        document.getElementById('caResultsContainer').style.display = 'none';
        document.getElementById('caNoResults').style.display = 'none';
        document.getElementById('caSummary').style.display = 'none';
        document.getElementById('bookingInstrumentsPanel').style.display = 'none';
        
        try {
            let url = `{{ base_path }}/api/ca/actions?days_ahead=${daysAhead}&booking_only=${bookingOnly}`;
            if (search) {
                url += `&search=${encodeURIComponent(search)}`;
            }
            
            const response = await fetch(url);
            
            if (response.status === 401) {
                window.location.href = '{{ base_path }}/login?next=' + encodeURIComponent(window.location.pathname);
                return;
            }
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to load corporate actions');
            }
            
            caData = data.actions;
            bookingInstruments = data.booking_instruments;
            
            // Hide loading
            document.getElementById('caLoading').style.display = 'none';
            
            if (caData.length === 0) {
                document.getElementById('caNoResults').style.display = 'block';
            } else {
                renderCorporateActions(caData);
                renderSummary(data);
                document.getElementById('caResultsContainer').style.display = 'block';
                document.getElementById('caSummary').style.display = 'grid';
            }
            
            // Show booking instruments if filter is active
            if (bookingOnly && bookingInstruments.length > 0) {
                renderBookingInstruments(bookingInstruments);
                document.getElementById('bookingInstrumentsPanel').style.display = 'block';
            }
            
        } catch (error) {
            document.getElementById('caLoading').style.display = 'none';
            showCAStatus('Error: ' + error.message, 'error');
        }
    }

    function renderCorporateActions(actions) {
        const tbody = document.getElementById('caTableBody');
        tbody.innerHTML = '';
        
        actions.forEach(ca => {
            const row = document.createElement('tr');
            
            // Format date
            const effDate = new Date(ca.effective_date);
            const dateStr = effDate.toLocaleDateString();
            
            // Days until badge
            const daysUntil = ca.days_until;
            let daysBadgeClass = 'upcoming';
            if (daysUntil <= 1) daysBadgeClass = 'urgent';
            else if (daysUntil <= 3) daysBadgeClass = 'soon';
            
            // CA type badge
            const caTypeClass = getCATypeClass(ca.ca_type);
            
            row.innerHTML = `
                <td>${dateStr}</td>
                <td><span class="days-badge ${daysBadgeClass}">${daysUntil}d</span></td>
                <td><strong>${ca.ticker || 'N/A'}</strong></td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
                    title="${ca.company_name || 'N/A'}">
                    ${ca.company_name || 'N/A'}
                </td>
                <td>
                    <span class="ca-type-badge ${caTypeClass}">
                        ${getCATypeDescription(ca.ca_type)}
                    </span>
                </td>
                <td>${ca.currency || '-'}</td>
                <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                    title="${ca.sector || 'N/A'}">
                    ${ca.sector || '-'}
                </td>
                <td>
                    <button 
                        class="view-details-btn" 
                        onclick="viewCADetails('${ca.action_id}', '${ca.ticker}')"
                    >
                        ðŸ“‹ Details
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    function renderSummary(data) {
        document.getElementById('totalCAs').textContent = data.total;
        
        // Count unique instruments
        const uniqueInstruments = new Set(data.actions.map(ca => ca.ticker)).size;
        document.getElementById('totalInstruments').textContent = uniqueInstruments;
        
        // Render CA types summary
        const caTypesContent = document.getElementById('caTypesContent');
        const summary = data.ca_type_summary || {};
        const topTypes = Object.entries(summary)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5);
        
        if (topTypes.length > 0) {
            caTypesContent.innerHTML = topTypes
                .map(([type, count]) => `${getCATypeDescription(type)}: ${count}`)
                .join('<br>');
        } else {
            caTypesContent.innerHTML = 'No data';
        }
    }

    function renderBookingInstruments(instruments) {
        const grid = document.getElementById('bookingInstrumentsGrid');
        const count = document.getElementById('bookingInstrCount');
        
        count.textContent = instruments.length;
        grid.innerHTML = '';
        
        instruments.forEach(instr => {
            const card = document.createElement('div');
            card.className = 'booking-instrument-card';
            card.innerHTML = `
                <div class="symbol">${instr.symbol}</div>
                <div class="details">
                    ID: ${instr.instr_id}<br>
                    Bookings: ${instr.booking_count}<br>
                    Qty: ${instr.total_quantity ? instr.total_quantity.toFixed(2) : '0'}
                </div>
            `;
            grid.appendChild(card);
        });
    }

    function getCATypeClass(mnemonic) {
        const typeMap = {
            'DIV': 'dividend',
            'SPL': 'split',
            'M&A': 'merger',
            'RTS': 'rights'
        };
        return typeMap[mnemonic] || '';
    }

    function getCATypeDescription(mnemonic) {
        const descriptions = {
            'DIV': 'Dividend',
            'SPL': 'Stock Split',
            'M&A': 'Merger & Acquisition',
            'RTS': 'Rights Issue',
            'SPO': 'Spin-off',
            'BYB': 'Buyback',
            'CAP': 'Capital Change',
            'CVR': 'Conversion',
            'RED': 'Redemption',
            'MAT': 'Maturity',
            'CAL': 'Call',
            'PUT': 'Put',
            'TND': 'Tender',
            'EXC': 'Exchange',
            'INT': 'Interest',
            'DEF': 'Defeasance',
            'BKR': 'Bankruptcy',
            'LIQ': 'Liquidation'
        };
        return descriptions[mnemonic] || mnemonic;
    }

    async function viewCADetails(actionId, ticker) {
        // Open modal with loading state
        const modal = document.getElementById('caDetailsModal');
        const modalBody = document.getElementById('modalBody');
        const modalTitle = document.getElementById('modalTitle');
        
        modalBody.innerHTML = `
            <div class="modal-loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #666;">Loading details...</p>
            </div>
        `;
        
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        try {
            const response = await fetch(`{{ base_path }}/api/ca/actions/${actionId}?ticker=${encodeURIComponent(ticker)}`);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to load details');
            }
            
            // Store data globally for copying
            window.currentCADetails = data;
            
            // Update modal title
            modalTitle.textContent = `${data.bccompanyname || 'Corporate Action'} - ${data.bcmnemonic || ''}`;
            
            // Format and display data
            modalBody.innerHTML = renderCADetails(data);
            
        } catch (error) {
            modalBody.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #f44336;">
                    <div style="font-size: 48px; margin-bottom: 15px;">⚠️</div>
                    <h3 style="margin-bottom: 10px;">Error Loading Details</h3>
                    <p>${error.message}</p>
                </div>
            `;
            showCAStatus('Error loading details: ' + error.message, 'error');
        }
    }

    function renderCADetails(data) {
        // Main details section
        const mainFields = [
            { label: 'Ticker', value: data.bcticker_exch_code },
            { label: 'Company Name', value: data.bccompanyname },
            { label: 'CA Type', value: `${data.bcmnemonic} - ${getCATypeDescription(data.bcmnemonic)}` },
            { label: 'Action ID', value: data.bcactionid },
            { label: 'Effective Date', value: data.bceffdate ? new Date(data.bceffdate).toLocaleDateString() : 'N/A' },
            { label: 'Announcement Date', value: data.bcanndate ? new Date(data.bcanndate).toLocaleDateString() : 'N/A' },
            { label: 'Currency', value: data.bccurrency },
            { label: 'Sector', value: data.bcmarketsectordescription },
            { label: 'Security ID', value: data.bcsecid },
            { label: 'Security ID Type', value: data.bcsecidtype },
            { label: 'Flag', value: data.bcflag },
        ];
        
        let html = '<div class="details-grid">';
        
        mainFields.forEach(field => {
            const value = field.value || 'N/A';
            const isEmpty = !field.value || field.value === 'N/A';
            html += `
                <div class="detail-item">
                    <div class="detail-label">${field.label}</div>
                    <div class="detail-value ${isEmpty ? 'empty' : ''}">${value}</div>
                </div>
            `;
        });
        
        html += '</div>';
        
        // Variable fields section
        if (data.variable_fields && data.variable_fields.length > 0) {
            html += `
                <div class="varfields-section">
                    <h3>📊 Variable Fields (${data.variable_fields.length})</h3>
                    <table class="varfields-table">
                        <thead>
                            <tr>
                                <th>Field ID</th>
                                <th>Value</th>
                                <th>Effective Date</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.variable_fields.forEach(field => {
                const effDate = field.eff_date ? new Date(field.eff_date).toLocaleDateString() : 'N/A';
                html += `
                    <tr>
                        <td><strong>${field.field_id}</strong></td>
                        <td>${field.value || 'N/A'}</td>
                        <td>${effDate}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        } else {
            html += `
                <div class="varfields-section">
                    <h3>📊 Variable Fields</h3>
                    <div class="no-varfields">No variable fields available for this corporate action</div>
                </div>
            `;
        }
        
        return html;
    }

    function closeCADetailsModal(event) {
        // Only close if clicking overlay or close button
        if (event && event.target.classList.contains('modal-dialog')) {
            return;
        }
        
        const modal = document.getElementById('caDetailsModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
        window.currentCADetails = null;
    }

    function copyCADetailsJSON() {
        if (!window.currentCADetails) {
            showCAStatus('No data to copy', 'error');
            return;
        }
        
        const json = JSON.stringify(window.currentCADetails, null, 2);
        
        navigator.clipboard.writeText(json).then(() => {
            const btn = document.getElementById('copyJsonBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '✓ Copied!';
            btn.style.background = '#388e3c';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = '';
            }, 2000);
            
            showCAStatus('JSON copied to clipboard', 'success');
        }).catch(err => {
            showCAStatus('Failed to copy: ' + err.message, 'error');
        });
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('caDetailsModal');
            if (modal.classList.contains('active')) {
                closeCADetailsModal();
            }
        }
    });

    function exportToCSV() {
        if (caData.length === 0) {
            showCAStatus('No data to export', 'error');
            return;
        }
        
        // CSV headers
        const headers = ['Date', 'Days Until', 'Ticker', 'Company', 'CA Type', 'Currency', 'Sector', 'Action ID'];
        
        // CSV rows
        const rows = caData.map(ca => [
            ca.effective_date,
            ca.days_until,
            ca.ticker || '',
            (ca.company_name || '').replace(/,/g, ';'), // Replace commas
            ca.ca_type || '',
            ca.currency || '',
            (ca.sector || '').replace(/,/g, ';'),
            ca.action_id || ''
        ]);
        
        // Build CSV
        const csv = [
            headers.join(','),
            ...rows.map(row => row.join(','))
        ].join('\n');
        
        // Download
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `corporate_actions_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showCAStatus('CSV exported successfully', 'success');
    }

    function showCAStatus(message, type) {
        const status = document.getElementById('caStatus');
        status.textContent = message;
        status.className = `status ${type}`;
        status.style.display = 'block';
        
        setTimeout(() => {
            status.style.display = 'none';
        }, 5000);
    }

    // Auto-load on tab switch
    document.addEventListener('DOMContentLoaded', function() {
        const caTabBtn = document.querySelector('[onclick*="corporate-actions"]');
        if (caTabBtn) {
            caTabBtn.addEventListener('click', function() {
                if (caData.length === 0) {
                    loadCorporateActions();
                }
            });
        }
    });
    </script>

    <!-- CA Details Modal -->
    <div id="caDetailsModal" class="modal-overlay" onclick="closeCADetailsModal(event)">
        <div class="modal-dialog" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Corporate Action Details</h2>
                <button class="modal-close" onclick="closeCADetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="modal-loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px; color: #666;">Loading details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="copy-json-btn" onclick="copyCADetailsJSON()" id="copyJsonBtn">
                    📋 Copy Raw JSON
                </button>
                <button onclick="closeCADetailsModal()" style="background: #666; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                    Close
                </button>
            </div>
        </div>
    </div>
</body>
</html>